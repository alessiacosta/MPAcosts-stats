---
title: "Global prediction"
format: html
---

# Loading packages

```{r}
library(readr)
library(dplyr)
library(tidyverse)
library(lubridate) # helps formatting the dates - form cleaned the dates from ymd time into only year
library(scales) # helps with the scientific notation
library(writexl) # helps with parallel processing
```

# Loading the dataset

```{r}
# Importing the data
MPA.Atlas <- read_csv("../Data/mpatlas_export_nogeo_202503/mpatlas_export_nogeo_202503.csv")
#View(MPA.Atlas)

# Extract MPA sizes (in km²)
mpa_sizes <- MPA.Atlas |>
  mutate(designated_date=year(ymd_hms(designated_date))) |> #cleans the designated date and extracts the year only
  select(designated_date, wdpa_pid, zone_area_calc) |>  
  filter(!is.na(zone_area_calc), zone_area_calc > 0) |>
  pull(zone_area_calc)
#View(mpa_sizes)
# Ocean stats
global_ocean_area <- 361e6 # Define total global ocean area (in km²)
initial_percent_protected <- 8.3 # Define the current protection level (as a percentage)
initial_area_km2 <- global_ocean_area * (initial_percent_protected / 100)# Calculate how many km² are already protected based on 8.3%
target_area_km2 <- global_ocean_area * 0.30# Calculate the target total protected area (30% of the ocean)
remaining_area_km2 <- target_area_km2 - initial_area_km2# Calculate how much additional area we need to protect
```

## Scenario 1: Total establishment costs of 30% coverage - using years vector based on the data I have collected

```{r}
establishment_years <- c(1, 2, 6, 9)# Define the establishment period (in years)

# Predicted cost per km² from your model (assumed preloaded as `pred_size`)
# We assume you already ran your model and have `pred_size` loaded
pred_size_lookup <- pred_size |> #picks up the prediction of establishment costs from my statistics estimates
  rename(cost_per_km2 = response) |> #renames the response variable 
  arrange(Size) # Ensure the data is sorted by MPA size (needed for interpolation)

# Interpolation function for cost per km²
get_predicted_cost <- function(size_km2) {
  approx(
    x = pred_size_lookup$Size, # x-axis variable--> Size
    y = pred_size_lookup$cost_per_km2, # y-axis variable--> cost_per_km2 corresponding to the size
    xout = size_km2, # The size we want to predict the cost for
    rule = 2 # Extrapolate if size is outside the range of the data
  )$y
}

# Run simulations for all establishment years
all_results <- list()

for (year in establishment_years) { #for loop to make simulations for each establishment year
  set.seed(123)  # for reproducibility
  mpa_total_area <- 0 # Initialize total area for this year
  mpa_records <- data.frame( # Creating an empty data frame to store MPA records
    mpa_id = 0, # Unique identifier for each simulated MPA
    size_km2 = 0, # Size of the MPA in km² --> gets filled later
    est_cost = 0, # Estimated cost for the MPA --> gets filled later
    cumulative_area = initial_area_km2, # Cumulative area protected
    cumulative_cost = 0, # Cumulative cost for the MPA --> no costs yet
    cumulative_percent = initial_percent_protected, #initial protection level
    establishment_year = year #add establishment duration as a variable
  )
  
  while (mpa_total_area < remaining_area_km2) { 
    mpa_size <- sample(mpa_sizes, 1) # Randomly sample an MPA size from the dataset mpa_sizes (filterd from MPAtlas) - the sampling is called mpa_size
    cost_rate <- get_predicted_cost(mpa_size) # Get the predicted cost per km² for the sampled size
    est_cost <- mpa_size * cost_rate * year #calculating establishment costs
    mpa_total_area <- mpa_total_area + mpa_size # Update the total area protected in this iteration
    
    new_row <- data.frame( # Creating a new row for the MPA record
      mpa_id = nrow(mpa_records), 
      size_km2 = mpa_size, #renames/creates variable mpa_size into size_km2
      est_cost = est_cost, #renames/creates variable est_cost into est_cost
      cumulative_area = initial_area_km2 + mpa_total_area, # equation for total area for MPA
      cumulative_cost = sum(mpa_records$est_cost) + est_cost, # equation for total cost for MPA --> uses establishment cost from previous rows and adds the current
      cumulative_percent = 100 * (initial_area_km2 + mpa_total_area) / global_ocean_area, # equation for total area protected in percentage
      establishment_year = year # each yearfrom the vector 
    )
    # Append the new row to the MPA records
    mpa_records <- bind_rows(mpa_records, new_row)
  }
  
  all_results[[as.character(year)]] <- mpa_records # Store results for this establishment year
}

# Combine all results
combined_results <- bind_rows(all_results)
View(combined_results)
# Plotting
#png("scenario1_all_years.png", width = 3300, height = 1800, res = 300)

ggplot(combined_results, aes(x = cumulative_percent, y = cumulative_cost / 1e9, color = factor(establishment_year))) +
  geom_line(size = 1.2) +
  geom_point(alpha = 0.3) +
  labs(
    x = "Total Ocean Protected (%)",
    y = "Cumulative Establishment Cost (Billion USD)",
    color = "Establishment\nPeriod (years)"
  ) +
  theme_minimal(base_size = 14) +
  geom_vline(xintercept = 8.3, linetype = "dashed", color = "gray40") +
  geom_vline(xintercept = 30, linetype = "dashed", color = "red") +
  annotate("text", x = 8.3, y = 0, label = "Existing (8.3%)", vjust = -1, color = "gray40") +
  annotate("text", x = 30, y = max(combined_results$cumulative_cost) / 1e9 * 0.9,
           label = "Target (30%)", color = "red", hjust = -0.1)

#dev.off()

```

## Scenario 1: Total establishment costs of 30% coverage - using years vector based on the data I calculated from the MPAtlas downloaded data

```{r}
#cleaning data first - extracting three columns from the MPA dataset: proposed date, designated date and wdpa_id
mpa_years <- MPA.Atlas |>
  mutate(
    proposed_date = year(ymd_hms(proposed_date)), #cleans the proposed date and extracts the year only
    designated_date = year(ymd_hms(designated_date))) |> # cleans the designated date and extracts the year only
  filter(!is.na(proposed_date),!is.na(designated_date)) |> 
  select(proposed_date, designated_date, wdpa_id)# Select relevant columns
#checking the dataset that is correct
View(mpa_years)
#Calculating the number of years for establishment, from the proposed date to the designated date
Tot_est_years <- mpa_years |> # Create a new column for the establishment period
  mutate(establishment_year = as.numeric(designated_date - proposed_date)) |> # Calculate the establishment period in years
  filter(establishment_year > 0) |> # Filter out negative or zero values
  select(wdpa_id, establishment_year) # Select relevant columns
# Double checking the data here
View(Tot_est_years)
#basic summary for establsihment years to decide which years to select 
summary(Tot_est_years) #picked 1 (min),3 (1st qu),4 (median),6 (mean) and,7 (3rd qu)

#Making a vector for the 
establishment_years <- c(1, 3, 4, 6, 7)# Define the establishment period (in years)

# Predicted cost per km² from your model (assumed preloaded as `pred_size`)
# We assume you already ran your model and have `pred_size` loaded
pred_size_lookup <- pred_size |> #picks up the prediction of establishment costs from my statistics estimates
  rename(cost_per_km2 = response) |> #renames the response variable 
  arrange(Size) # Ensure the data is sorted by MPA size (needed for interpolation)

# Interpolation function for cost per km²
get_predicted_cost <- function(size_km2) {
  approx(
    x = pred_size_lookup$Size, # x-axis variable--> Size
    y = pred_size_lookup$cost_per_km2, # y-axis variable--> cost_per_km2 corresponding to the size
    xout = size_km2, # The size we want to predict the cost for
    rule = 2 # Extrapolate if size is outside the range of the data
  )$y
}

# Run simulations for all establishment years
all_results <- list()

for (year in establishment_years) { #for loop to make simulations for each establishment year
  set.seed(123)  # for reproducibility
  mpa_total_area <- 0 # Initialize total area for this year
  mpa_records <- data.frame( # Creating an empty data frame to store MPA records
    mpa_id = 0, # Unique identifier for each simulated MPA
    size_km2 = 0, # Size of the MPA in km² --> gets filled later
    est_cost = 0, # Estimated cost for the MPA --> gets filled later
    cumulative_area = initial_area_km2, # Cumulative area protected
    cumulative_cost = 0, # Cumulative cost for the MPA --> no costs yet
    cumulative_percent = initial_percent_protected, #initial protection level
    establishment_year = year #add establishment duration as a variable
  )
  
  while (mpa_total_area < remaining_area_km2) { 
    mpa_size <- sample(mpa_sizes, 1) # Randomly sample an MPA size from the dataset
    cost_rate <- get_predicted_cost(mpa_size) # Get the predicted cost per km² for the sampled size
    est_cost <- mpa_size * cost_rate * year #calculating establishment costs
    mpa_total_area <- mpa_total_area + mpa_size # Update the total area protected in this iteration
    
    new_row <- data.frame( # Creating a new row for the MPA record
      mpa_id = nrow(mpa_records), 
      size_km2 = mpa_size, #renames/creates variable mpa_size into size_km2
      est_cost = est_cost, #renames/creates variable est_cost into est_cost
      cumulative_area = initial_area_km2 + mpa_total_area, # equation for total area for MPA
      cumulative_cost = sum(mpa_records$est_cost) + est_cost, # equation for total cost for MPA --> uses establishment cost from previous rows and adds the current
      cumulative_percent = 100 * (initial_area_km2 + mpa_total_area) / global_ocean_area, # equation for total area protected in percentage
      establishment_year = year # each year from the vector 
    )
    # Append the new row to the MPA records
    mpa_records <- bind_rows(mpa_records, new_row)
  }
  
  all_results[[as.character(year)]] <- mpa_records # Store results for this establishment year
}

# Combine all results
combined_results <- bind_rows(all_results)
View(combined_results)

# Plotting
png("scenario1_all_years_MPAtlas.png", width = 3300, height = 1800, res = 300)
ggplot(combined_results, aes(x = cumulative_percent, y = cumulative_cost / 1e07, color = factor(establishment_year))) +
  geom_line(size = 1.2) +
  geom_point(alpha = 0.3) +
  labs(
    x = "Total Ocean Protected (%)",
    y = "Cumulative Establishment\nCost (Billion USD)",
    color = "Establishment\nPeriod (years)"
  ) +
  theme_minimal(base_size = 14) +
  xlim(5, 35) + 
  theme(
    axis.minor.ticks.length = rel(1)
  ) +
  scale_y_continuous(labels = scientific) +
  geom_vline(xintercept = 8.3, linetype = "dashed", color = "gray40") +
  geom_vline(xintercept = 30, linetype = "dashed", color = "red") +
  annotate("text", x = 8.3, y = 0, label = "Existing\n8.3%", vjust = -2, color = "black") +
  annotate("text", x = 30, y = max(combined_results$cumulative_cost) / 1e9 * 0.9,
           label = "Target\n30%", color = "red", hjust = -0.1)
dev.off()

```

## Scenario 2: How long is it going to take to reach 30% coverage

```{r}
establishment_years <- 4 # Define the establishment period (in years) - using 4 because it is the median from the data I have
#Cleaning data first - calculating the annual number of mpas per year or the % coverage per year
mpa <- MPA.Atlas |> 
  mutate(designated_date=year(ymd_hms(designated_date))) |> #cleans the designated date and extracts the year only
  select(designated_date, wdpa_pid, zone_area_calc) |>  
  filter(!is.na(designated_date), !is.na(zone_area_calc))  # Filter out negative or zero values
#Check data format 
#View(mpa)

#group by year and calculate the total area protected in each year
mpa_yearly1 <- mpa |> 
  group_by(designated_date) |> #group data by year
  summarise(total_area = sum(zone_area_calc)) |> #sum the area protected in each year
  ungroup()
#looking at a basic summary of the data 
View(mpa_yearly1)
summary(mpa_yearly1)
mean_area = mean(mpa_yearly1$total_area) #calculate the mean total area protected per year
mean_percent = 100 * mean_area / global_ocean_area#calculate the cumulative percentage of area protected

# Calculate the cumulative area protected over time --> this is only to produce the ggplot below
mpa_yearly <- mpa_yearly1 |>  #ungroup the data
  mutate(cumulative_area = cumsum(total_area)) |> #calculate the cumulative area protected in km2
  mutate(cumulative_percent = 100 * cumulative_area / global_ocean_area) |> #calculate the cumulative percentage of area protected
  select(designated_date, cumulative_area, cumulative_percent) #select relevant columns
#View(mpa_yearly)
# Plotting the cumulative area protected over time
png("rateofprotectionto2025.png", width = 3300, height = 1800, res = 300)
ggplot(mpa_yearly, aes(x = designated_date, y = cumulative_percent)) +
  geom_line(size = 1.2) +
  geom_point(alpha = 0.3) +
  labs(
    x = "Year",
    y = "Cumulative Area Protected (%)"
  ) +
  theme_minimal(base_size = 14) +
  geom_hline(yintercept = 30, linetype = "dashed", color = "red") +
  geom_hline(yintercept = 8.3, linetype = "dashed", color = "gray40") +
  annotate("text", x = max(mpa_yearly$designated_date), y = 30,
           label = "Target 30%", color = "red", hjust = 1, vjust = 1.3) +
    annotate("text", x = max(mpa_yearly$designated_date), y = 30,
           label = "Current %", color = "grey40", hjust = 1, vjust = 22)
dev.off()
```

```{r}
# simulated years 2025 + 1
sim_years <-max(mpa_yearly1$designated_date) + 1  # Define the years for simulation

#create a new dataset based on the combined_results, only selecting establishment years at 4
combined_results1 <- combined_results |>
  filter(establishment_year == 4)
View(combined_results1)

get_predicted_costs <- function(size_km2) {
  approx(
    x = combined_results1$cumulative_area, # x-axis variable--> Size
    y = combined_results1$cumulative_cost, # y-axis variable--> cost_per_km2 corresponding to the size
    xout = size_km2, # The size we want to predict the cost for
    rule = 2 # Extrapolate if size is outside the range of the data
  )$y
}

# Initialize results data frame
mpa_records <- data.frame(
  year = 2025, # Year of simulation
  size_km2 = 0, # Size of the MPA in km² --> gets filled later
  est_cost = 0, # Estimated cost for the MPA --> gets filled later
  cumulative_area = initial_area_km2, # Cumulative area protected
  cumulative_cost = 0, # Cumulative cost for the MPA --> no costs yet
  cumulative_percent = initial_percent_protected  #initial protection level
)
#View(mpa_records)
# Simulation
set.seed(123) # for reproducibility
mpa_total_area <- 0 # Initialize total area for this year 

while ((initial_area_km2 + mpa_total_area) / global_ocean_area < 0.30) { 
  mpa_size <- sample(mpa_yearly1$total_area, 1) # Randomly sample an MPA size from the dataset
  cost_rate <- get_predicted_costs(mpa_size) # Get the predicted cost per km² for the sampled size
  est_cost <- mpa_size * cost_rate  #calculating establishment costs
  mpa_total_area <- mpa_total_area + mpa_size # Update the total area protected in this iteration

  new_row <- data.frame( # Creating a new row for the MPA record
    year = sim_years, # Year of simulation
    size_km2 = mpa_size, # Size of the MPA in km²
    est_cost = est_cost, # Estimated cost for the MPA --> gets filled later
    cumulative_area = initial_area_km2 + mpa_total_area, # equation for total area for MPA
    cumulative_cost = sum(mpa_records$est_cost) + est_cost, # equation for total cost for MPA --> uses establishment cost from previous rows and adds the current
    cumulative_percent = 100 * (initial_area_km2 + mpa_total_area) / global_ocean_area # equation for total area protected in percentage
  )

  mpa_records <- bind_rows(mpa_records, new_row)
  sim_years <- sim_years + 1 # Increment the year for the next iteration
}
#checking the data
View(mpa_records)

#plotting the loop results 
png("rateofprotectionto30.png", width = 3300, height = 1800, res = 300)
ggplot(mpa_records, aes(x = year, y =cumulative_percent)) +
  geom_line(size = 1.2, color="darkgreen") +
  theme_minimal(base_size = 14) +
  geom_hline(yintercept = 30, linetype = "dashed", color = "red") +
  scale_y_continuous(sec.axis=sec_axis( ~ ./1.e9, # Create a secondary y-axis for cumulative cost
      name = "Establishment cost (USD)")) + # Format the y-axis labels as percentages
  labs(
    x = "Years",
    y = "Percentage of coverage") + 
  theme(
    text=element_text(family='serif'), 
    axis.line = element_line(colour = "darkgrey"),
    axis.ticks = element_line(colour = "black"),
  )
dev.off()
```

Scenario 3: Maintenance costs for current size distribution of MPAs

```{r}
#Calculate the initial management costs at 8.3% coverage based on the estimates from Brander et al., 2020 - based on 10% cover NPV 
# This will give me a total cost for the 10% coverage 
#i=0.03
#t=2050-2015
#NPV = 51625396492
#R = NPV * (1+i)^t
#Rt = R/t

# Step 1: Prepare the predicted cost lookup table from the model
# Assumes `pred_size` contains: Size, Protection_level (if any), and response (predicted cost per km² per year)
pred_size_lookup2 <- pred_size2 |>
  rename(cost_per_km2_per_year = response) |>  # Make column name explicit for clarity
  arrange(Size)  # Ensure sorted for interpolation

# Step 2: Define an interpolation function for predicted annual cost per km²
get_predicted_cost <- function(size_km2) {
  approx(
    x = pred_size_lookup2$Size,                 # Known sizes
    y = pred_size_lookup2$cost_per_km2_per_year, # Corresponding predicted management cost
    xout = size_km2,                            # Size to predict cost for
    rule = 2                                    # Allow extrapolation
  )$y
}

# Step 3: Set initial conditions
#Rt <- initial_area_km2 * get_predicted_cost(mean(mpa_sizes))  # Estimate baseline cost at 8.3% using mean size
i=0.03 # 3% discount rate
t=2050-2015 # #Number fo years between 2015 and 2050
NPV = 51625396492
R = NPV * (1+i)^t
Rt = R/t

# Initialize results data frame with the initial 8.3% protection state and cost Rt
mpa_records <- data.frame(
  mpa_id = 0,                                 # First record (baseline)
  size_km2 = 0,                               # No new MPA added yet
  annual_cost = Rt,                           # Starting annual management cost (Rt)
  cumulative_area = initial_area_km2,         # Starting area is 8.3% of global ocean
  cumulative_cost = Rt,                       # Total cost is Rt at t=0
  cumulative_percent = initial_percent_protected  # 8.3% protected initially
)

# Step 4: Run simulation to incrementally add MPAs until reaching 30%
set.seed(123)  # Ensure reproducibility
mpa_total_area <- 0  # New area to be added (beyond initial 8.3%)

while (mpa_total_area < remaining_area_km2) {
  mpa_size <- sample(mpa_sizes, 1)  # Sample an MPA size from real-world data
  cost_rate <- get_predicted_cost(mpa_size)  # Predicted cost per km² per year
  annual_cost <- mpa_size * cost_rate        # Annual cost for this MPA
  
  mpa_total_area <- mpa_total_area + mpa_size  # Track how much area we've added

  # Add new row to the results
  new_row <- data.frame(
    mpa_id = nrow(mpa_records),                      # Assign ID
    size_km2 = mpa_size,                             # Size of new MPA
    annual_cost = annual_cost,                       # Yearly management cost
    cumulative_area = initial_area_km2 + mpa_total_area,  # Update total area
    cumulative_cost = sum(mpa_records$annual_cost) + annual_cost,  # Running total cost
    cumulative_percent = 100 * (initial_area_km2 + mpa_total_area) / global_ocean_area  # As % of ocean
  )

  # Append to dataset
  mpa_records <- bind_rows(mpa_records, new_row)
}

# Step 5: Plot results
png("scenario2_maintenance.png", width = 3300, height = 1800, res = 300)
ggplot(mpa_records, aes(x = cumulative_percent, y = cumulative_cost / 1e9)) +
  geom_line(color = "darkblue", size = 1.2) +                 # Line plot of cost vs. % protected
  geom_point(alpha = 0.3, color = "darkblue") +               # Scatter for each data point
  labs(
    x = "Total Ocean Protected (%)",
    y = "Cumulative Annual Management\nCost (Billion USD)"
  ) +
  theme_minimal(base_size = 14) +                             # Clean theme
  geom_vline(xintercept = 8.3, linetype = "dashed", color = "black") +  # Mark current status
  geom_vline(xintercept = 30, linetype = "dashed", color = "red") +      # Mark 30% goal
  annotate("text", x = 8.3, y = 0, label = "Existing\n8.3%", vjust = -1.5, hjust=0.5, color = "black") +
  annotate("text", x = 30, y = max(mpa_records$cumulative_cost) / 1e9 * 0.9,
           label = "Target\n30%", color = "red", hjust = 1.2, vjust = 1)
dev.off()

```

## Scenario 4: Reach 30% coverage by 2030

```{r}
# Define the target year
target_year <- 2030 # Define the target year for 30% coverage
# Calculate the number of years remaining until the target year
remaining_years <- target_year - max(mpa_yearly1$designated_date) # Calculate the remaining years until the target year
# Calculate the annual area needed to reach 30% coverage
annual_area_needed <- (target_area_km2 - initial_area_km2) / remaining_years # Calculate the annual area needed to reach 30% coverage
# Calculate the annual percentage needed to reach 30% coverage
annual_percent_needed <- annual_area_needed/ global_ocean_area * 100 # Calculate the annual percentage needed to reach 30% coverage
# Print the results
cat("Annual area needed to reach 30% coverage:", annual_area_needed, "km²\n")
```
